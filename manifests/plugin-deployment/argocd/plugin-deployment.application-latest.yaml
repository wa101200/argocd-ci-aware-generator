apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: argocd-validate-ci-checks-generators-plugin
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  description: argocd-validate-ci-checks-generators-plugin

  # not a good idea to use wildcards but we are in dev mode now and this project won't live long
  clusterResourceWhitelist:
    - group: "*"
      kind: "*"

  destinations:
    - namespace: "*"
      server: https://kubernetes.default.svc
  sourceRepos:
    - git@github.com:wa101200/argocd-validate-ci-cheks-generators.git
    - https://stakater.github.io/stakater-charts
    - https://redis-stack.github.io/helm-redis-stack/
    - https://wa101200.github.io/argocd-ci-aware-generator/
---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: argocd-validate-ci-checks-generators-plugin-latest
  namespace: argocd
spec:
  generators:
    - scmProvider:
        github:
          organization: wa101200
          # If true, scan every branch of every repository. If false, scan only the default branch. Defaults to false.
          allBranches: true
          tokenRef:
            secretName: github-token
            key: token
        filters:
          - repositoryMatch: ^argocd-ci-aware-generator
            branchMatch: master

  template:
    metadata:
      name: argocd-validate-ci-checks-generators-plugin-latest
      namespace: argocd
    spec:
      project: argocd-validate-ci-checks-generators-plugin
      syncPolicy:
        syncOptions:
          - CreateNamespace=true
        automated:
          prune: true
          selfHeal: true
      sources:
        - chart: argocd-ci-aware-generator-plugin
          repoURL: https://wa101200.github.io/argocd-ci-aware-generator/
          targetRevision: "0.0.8"
          helm:
            releaseName: plugin
            valuesObject:
              application:
                deployment:
                  image:
                    tag: "{{ sha }}"
            valueFiles:
              - $values/manifests/plugin-deployment/values/plugin-deployment.values.yaml

        - repoURL: git@github.com:wa101200/argocd-validate-ci-cheks-generators
          targetRevision: "{{ sha }}"
          ref: values

      destination:
        server: "https://kubernetes.default.svc"
        namespace: argocd-validate-ci-checks-generators-plugin-latest
